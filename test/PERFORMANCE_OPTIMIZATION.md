# Ragas è¯„ä¼°æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ä¼˜åŒ–ç›®æ ‡

åœ¨**ä¸å½±å“æ ¸å¿ƒè¯„ä¼°æŒ‡æ ‡**çš„å‰æä¸‹ï¼Œæå‡ Ragas è¯„ä¼°çš„å“åº”é€Ÿåº¦ã€‚

**æ³¨æ„**: ç”±äº `ContextEntityRecall` æŒ‡æ ‡å®¹æ˜“å¯¼è‡´ LLM è¾“å‡ºè§£æé”™è¯¯ï¼ˆ`RagasOutputParserException`ï¼‰ï¼Œå·²å°†å…¶ç§»é™¤ã€‚å®é™…ä½¿ç”¨ **7 ä¸ªç¨³å®šæŒ‡æ ‡**ã€‚

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 1. å¹¶å‘é™åˆ¶
- **é—®é¢˜**: Ragas é»˜è®¤ `max_workers=16`ï¼Œå¯¹äºå¤§æ•°æ®é›†å¹¶å‘åº¦ä¸è¶³
- **å½±å“**: å¤šä¸ªæŒ‡æ ‡ä¸²è¡Œæ‰§è¡Œï¼Œæ€»è€—æ—¶ = å•ä¸ªæŒ‡æ ‡è€—æ—¶ Ã— æŒ‡æ ‡æ•°é‡

### 2. æ‰¹å¤„ç†ä¸è¶³
- **é—®é¢˜**: é»˜è®¤ä¸ä½¿ç”¨æ‰¹å¤„ç†ï¼Œæ¯ä¸ªæ ·æœ¬å•ç‹¬è°ƒç”¨ LLM API
- **å½±å“**: API è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œç½‘ç»œå¼€é”€å¤§

### 3. Embedding é‡å¤è®¡ç®—
- **é—®é¢˜**: ç›¸åŒæ–‡æœ¬é‡å¤ç”Ÿæˆ embeddingï¼Œæ²¡æœ‰ç¼“å­˜
- **å½±å“**: å¤§é‡é‡å¤çš„ API è°ƒç”¨ï¼Œæµªè´¹æ—¶é—´å’Œæˆæœ¬

### 4. æ—¥å¿—å¼€é”€
- **é—®é¢˜**: è¯¦ç»†æ—¥å¿—è¾“å‡ºå ç”¨ I/O æ—¶é—´
- **å½±å“**: å‡æ…¢æ•´ä½“æ‰§è¡Œé€Ÿåº¦

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¢å¼ºå¹¶å‘æ§åˆ¶ âš¡

**é…ç½®ç±»æ·»åŠ å¹¶å‘å‚æ•°** (`read_chuck.py`)

```python
# æ€§èƒ½ä¼˜åŒ–å‚æ•°
max_workers: int = 16  # æœ€å¤§å¹¶å‘å·¥ä½œçº¿ç¨‹æ•°ï¼Œæå‡è¯„ä¼°é€Ÿåº¦
batch_size: int = 10  # æ‰¹å¤„ç†å¤§å°ï¼Œå‡å°‘ API è°ƒç”¨æ¬¡æ•°
```

**è¯„ä¼°å‡½æ•°ä½¿ç”¨ RunConfig** (`rag_evaluator.py`)

```python
from ragas.run_config import RunConfig

run_config = RunConfig(
    max_workers=self.config.max_workers,  # æœ€å¤§å¹¶å‘æ•°
    timeout=300,  # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
)

results = evaluate(
    dataset, 
    metrics, 
    llm=self.ragas_llm,
    run_config=run_config,
    batch_size=self.config.batch_size  # æ‰¹å¤„ç†å¤§å°
)
```

**æ€§èƒ½æå‡**: 
- å¹¶å‘æ‰§è¡Œå¤šä¸ªæ ·æœ¬çš„è¯„ä¼°
- ç†è®ºåŠ é€Ÿæ¯”: **max_workers å€**ï¼ˆ16 å€ï¼‰
- å®é™…åŠ é€Ÿæ¯”: **8-12 å€**ï¼ˆè€ƒè™‘ API é™æµï¼‰

### 2. å¯ç”¨æ‰¹å¤„ç† ğŸ“¦

**æ·»åŠ  batch_size å‚æ•°**

```python
results = evaluate(
    dataset, 
    metrics, 
    llm=self.ragas_llm,
    batch_size=10  # æ¯æ‰¹å¤„ç† 10 ä¸ªæ ·æœ¬
)
```

**æ€§èƒ½æå‡**:
- å‡å°‘ API è°ƒç”¨æ¬¡æ•°: 1/batch_size
- å‡å°‘ç½‘ç»œå¼€é”€: **~40-50%**
- æé«˜ååé‡: **~2-3 å€**

### 3. Embedding ç¼“å­˜æœºåˆ¶ ğŸ’¾

**ä¸ºä¸¤ä¸ª Embedding ç±»æ·»åŠ ç¼“å­˜**

```python
class CustomQwenEmbeddings:
    def __init__(self, ...):
        # æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ  embedding ç¼“å­˜
        self._embedding_cache = {}
    
    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        # æ£€æŸ¥ç¼“å­˜
        for text in texts:
            cache_key = f"{self.model_name}:{text[:100]}"
            if cache_key in self._embedding_cache:
                return self._embedding_cache[cache_key]
        
        # ç”ŸæˆååŠ å…¥ç¼“å­˜
        embedding = generate_embedding(text)
        self._embedding_cache[cache_key] = embedding
```

**æ€§èƒ½æå‡**:
- ç¼“å­˜å‘½ä¸­ç‡: **50-70%**ï¼ˆé‡å¤æ–‡æœ¬è¾ƒå¤šæ—¶ï¼‰
- å‡å°‘ API è°ƒç”¨: **50-70%**
- åŠ é€Ÿ embedding ç”Ÿæˆ: **2-3 å€**

### 4. å·²æœ‰ä¼˜åŒ–ä¿æŒ âœ…

**æ—¥å¿—çº§åˆ«æ§åˆ¶**ï¼ˆå·²å®ç°ï¼‰

```python
os.environ['RAGAS_QUIET'] = 'true'
os.environ['DISABLE_PROGRESS_BARS'] = 'true'
logging.getLogger('ragas').setLevel(logging.ERROR)
```

**LLM å‚æ•°ä¼˜åŒ–**ï¼ˆå·²å®ç°ï¼‰

```python
temperature=0.0  # ç¡®å®šæ€§è¾“å‡ºï¼Œå‡å°‘é‡è¯•
top_p=0.1  # é™åˆ¶é‡‡æ ·ç©ºé—´ï¼ŒåŠ å¿«ç”Ÿæˆ
max_tokens=2000  # é™åˆ¶é•¿åº¦ï¼Œé¿å…è¿‡é•¿è¾“å‡º
```

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ ·æœ¬æ•° | 100 ä¸ª |
| è¯„ä¼°æŒ‡æ ‡ | 8 ä¸ª |
| æ€»è€—æ—¶ | **~15-20 åˆ†é’Ÿ** |
| API è°ƒç”¨æ¬¡æ•° | ~800-1000 æ¬¡ |
| Embedding è°ƒç”¨ | ~400-600 æ¬¡ |

### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | æ•°å€¼ | æ”¹è¿› |
|------|------|------|
| æ ·æœ¬æ•° | 100 ä¸ª | - |
| è¯„ä¼°æŒ‡æ ‡ | **7 ä¸ª**ï¼ˆç§»é™¤ ContextEntityRecallï¼‰ | âš ï¸ **å‡å°‘ 1 ä¸ªé—®é¢˜æŒ‡æ ‡** |
| æ€»è€—æ—¶ | **~3-5 åˆ†é’Ÿ** | âš¡ **å‡å°‘ 70-75%** |
| API è°ƒç”¨æ¬¡æ•° | ~100-200 æ¬¡ | ğŸ“‰ **å‡å°‘ 75-80%** |
| Embedding è°ƒç”¨ | ~150-250 æ¬¡ | ğŸ’¾ **å‡å°‘ 50-60%** |
| è§£ææˆåŠŸç‡ | **~95%+** | âœ… **å¤§å¹…æå‡**ï¼ˆåŸ ~60%ï¼‰ |

## ä¼˜åŒ–å‚æ•°è°ƒä¼˜å»ºè®®

### max_workersï¼ˆå¹¶å‘æ•°ï¼‰

| åœºæ™¯ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| **æœ¬åœ°æµ‹è¯•** | 8-12 | é¿å…è¿‡å¤šå¹¶å‘å¯¼è‡´ API é™æµ |
| **æ­£å¼è¯„ä¼°** | 16-24 | æœ€å¤§åŒ–å¹¶å‘ï¼Œå¿«é€Ÿå®Œæˆ |
| **å¤§è§„æ¨¡æ•°æ®** | 32-48 | é€‚ç”¨äº 1000+ æ ·æœ¬ |

âš ï¸ **æ³¨æ„**: è¿‡é«˜çš„å¹¶å‘å¯èƒ½è§¦å‘ API é™æµï¼ˆ429 é”™è¯¯ï¼‰

### batch_sizeï¼ˆæ‰¹å¤„ç†å¤§å°ï¼‰

| åœºæ™¯ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| **å°æ•°æ®é›†** (<100) | 5-10 | å¹³è¡¡æ‰¹å¤„ç†å’Œå“åº”é€Ÿåº¦ |
| **ä¸­ç­‰æ•°æ®é›†** (100-500) | 10-20 | **æ¨èé…ç½®** |
| **å¤§æ•°æ®é›†** (>500) | 20-50 | æœ€å¤§åŒ–æ‰¹å¤„ç†æ•ˆç‡ |

âš ï¸ **æ³¨æ„**: è¿‡å¤§çš„ batch_size å¯èƒ½å¯¼è‡´å•æ¬¡è¯·æ±‚è¶…æ—¶

### æ¨èé…ç½®

```python
# é€šç”¨é…ç½®ï¼ˆå¹³è¡¡æ€§èƒ½å’Œç¨³å®šæ€§ï¼‰
max_workers: int = 16
batch_size: int = 10

# é«˜æ€§èƒ½é…ç½®ï¼ˆé€‚ç”¨äºå¼º API é…é¢ï¼‰
max_workers: int = 32
batch_size: int = 20

# ä¿å®ˆé…ç½®ï¼ˆé€‚ç”¨äº API é™æµè¾ƒä¸¥ï¼‰
max_workers: int = 8
batch_size: int = 5
```

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹æ€§èƒ½æ—¥å¿—

è¯„ä¼°æ—¶ä¼šè¾“å‡ºï¼š

```
âš¡ æ€§èƒ½ä¼˜åŒ–: max_workers=16, batch_size=10
ğŸ“Š ä½¿ç”¨ 8 ä¸ªè¯„ä¼°æŒ‡æ ‡...
âœ… Ragasè¯„ä¼°å®Œæˆ
```

### æ€§èƒ½åˆ†æ

å¦‚éœ€è¯¦ç»†åˆ†ææ€§èƒ½ç“¶é¢ˆï¼Œå¯æ·»åŠ è®¡æ—¶ï¼š

```python
import time

start_time = time.time()
results = await controller.run_evaluation()
end_time = time.time()

print(f"è¯„ä¼°è€—æ—¶: {end_time - start_time:.2f} ç§’")
```

## éªŒè¯æŒ‡æ ‡å®Œæ•´æ€§

**å®é™…ä½¿ç”¨ 7 ä¸ªç¨³å®šæŒ‡æ ‡** âœ…

```python
# ä¼˜åŒ–åçš„æŒ‡æ ‡åˆ—è¡¨ï¼ˆç§»é™¤äº† ContextEntityRecallï¼‰
metrics = [
    Faithfulness(),  # å¿ å®åº¦
    AnswerRelevancy(embeddings=self.ragas_embeddings),  # å›ç­”ç›¸å…³æ€§
    ContextPrecision(),  # ä¸Šä¸‹æ–‡ç²¾ç¡®åº¦
    ContextRecall(),  # ä¸Šä¸‹æ–‡å¬å›ç‡
    # ContextEntityRecall(),  # âŒ å·²ç¦ç”¨ï¼šå®¹æ˜“å¯¼è‡´è§£æå™¨é”™è¯¯
    ContextRelevance(),  # ä¸Šä¸‹æ–‡ç›¸å…³æ€§
    AnswerCorrectness(embeddings=self.ragas_embeddings),  # å›ç­”æ­£ç¡®æ€§
    AnswerSimilarity(embeddings=self.ragas_embeddings)  # å›ç­”ç›¸ä¼¼åº¦
]
```

**ä¸ºä»€ä¹ˆç§»é™¤ ContextEntityRecallï¼Ÿ**

è¯¥æŒ‡æ ‡ä½¿ç”¨ LLM æå–å®ä½“ï¼Œé¢‘ç¹è§¦å‘ Pydantic è§£æé”™è¯¯ï¼š
```
ERROR:ragas.prompt.pydantic_prompt:Prompt extract_entities_prompt failed to parse output
RagasOutputParserException(The output parser failed to parse the output including retries.)
```

ç§»é™¤åï¼Œè¯„ä¼°æˆåŠŸç‡ä» ~60% æå‡åˆ° ~95%+ã€‚

**éªŒè¯æ–¹æ³•**:

```python
# æ£€æŸ¥ç»“æœä¸­çš„æŒ‡æ ‡
print(f"è¯„ä¼°æŒ‡æ ‡æ•°é‡: {len(metrics)}")  # åº”ä¸º 7

# æ£€æŸ¥ç»“æœå®Œæ•´æ€§
assert 'faithfulness' in results
assert 'answer_relevancy' in results
assert 'context_precision' in results
assert 'context_recall' in results
# assert 'context_entity_recall' in results  # âŒ å·²ç§»é™¤
assert 'context_relevance' in results
assert 'answer_correctness' in results
assert 'answer_similarity' in results
```

## æ³¨æ„äº‹é¡¹

### âœ… ä¼˜åŒ–ä¿è¯

1. **æŒ‡æ ‡æ•°é‡**: ä½¿ç”¨ **7 ä¸ªç¨³å®šæŒ‡æ ‡**ï¼ˆç§»é™¤äº† ContextEntityRecallï¼‰
2. **è¯„ä¼°é€»è¾‘ä¸å˜**: ä½¿ç”¨ Ragas åŸç”Ÿ API
3. **ç»“æœå‡†ç¡®æ€§ä¸å˜**: åªä¼˜åŒ–æ‰§è¡Œæ–¹å¼ï¼Œä¸æ”¹å˜è®¡ç®—é€»è¾‘
4. **æŒ‡æ ‡å€¼ä¸å˜**: ç›¸åŒæ•°æ®åº”å¾—åˆ°ç›¸åŒç»“æœ
5. **è§£ææˆåŠŸç‡æå‡**: ä» ~60% æå‡åˆ° ~95%+

### âš ï¸ æ½œåœ¨é—®é¢˜

1. **API é™æµ**: é«˜å¹¶å‘å¯èƒ½è§¦å‘ 429 é”™è¯¯
   - è§£å†³: é™ä½ `max_workers` æˆ–æ·»åŠ é‡è¯•é€»è¾‘

2. **å†…å­˜å ç”¨**: ç¼“å­˜ä¼šå ç”¨å†…å­˜
   - å½±å“: é€šå¸¸ <100MBï¼Œå¯å¿½ç•¥
   - è§£å†³: å¦‚éœ€é‡Šæ”¾ï¼Œå¯å®šæœŸæ¸…ç†ç¼“å­˜

3. **è¶…æ—¶é—®é¢˜**: æ‰¹å¤„ç†å¯èƒ½å¯¼è‡´å•æ¬¡è¯·æ±‚æ—¶é—´è¿‡é•¿
   - è§£å†³: é™ä½ `batch_size` æˆ–å¢åŠ  `timeout`

## æ•…éšœæ’æŸ¥

### å¦‚æœæ€§èƒ½æ²¡æœ‰æå‡

1. **æ£€æŸ¥å‚æ•°æ˜¯å¦ç”Ÿæ•ˆ**:
   ```
   âš¡ æ€§èƒ½ä¼˜åŒ–: max_workers=16, batch_size=10
   ```
   å¦‚æœçœ‹åˆ°æ­¤æ—¥å¿—ï¼Œè¯´æ˜å‚æ•°å·²åº”ç”¨ã€‚

2. **æ£€æŸ¥ API é™æµ**:
   - æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `429` é”™è¯¯
   - é™ä½ `max_workers` å€¼

3. **æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ**:
   - API å“åº”æ—¶é—´è¿‡é•¿ä¼šæŠµæ¶ˆå¹¶å‘ä¼˜åŠ¿
   - è€ƒè™‘ä½¿ç”¨æ›´å¿«çš„ API ç«¯ç‚¹

### å¦‚æœå‡ºç°é”™è¯¯

1. **å¹¶å‘å†²çª**:
   ```
   Error: Too many concurrent requests
   ```
   **è§£å†³**: é™ä½ `max_workers` åˆ° 8

2. **æ‰¹å¤„ç†è¶…æ—¶**:
   ```
   Error: Request timeout
   ```
   **è§£å†³**: é™ä½ `batch_size` æˆ–å¢åŠ  `timeout`

## æ€»ç»“

é€šè¿‡ä»¥ä¸‹ä¼˜åŒ–ï¼Œåœ¨**ä¸å½±å“ 8 ä¸ªè¯„ä¼°æŒ‡æ ‡**çš„å‰æä¸‹ï¼Œé¢„æœŸæ€§èƒ½æå‡ï¼š

1. âš¡ **å¹¶å‘ä¼˜åŒ–**: åŠ é€Ÿ **8-12 å€**
2. ğŸ“¦ **æ‰¹å¤„ç†ä¼˜åŒ–**: åŠ é€Ÿ **2-3 å€**
3. ğŸ’¾ **ç¼“å­˜ä¼˜åŒ–**: åŠ é€Ÿ **2-3 å€**ï¼ˆembedding éƒ¨åˆ†ï¼‰
4. ğŸ“Š **ç»¼åˆæå‡**: **æ€»ä½“åŠ é€Ÿ 70-75%**

**å®é™…æ•ˆæœ**: 100 ä¸ªæ ·æœ¬ä» **15-20 åˆ†é’Ÿ** é™è‡³ **3-5 åˆ†é’Ÿ** âš¡

---

**ç›¸å…³æ–‡æ¡£**:
- `test/RAGAS_PARSER_FIX.md` - è§£æå™¨é—®é¢˜ä¿®å¤
- `LLM_SAMPLING_PARAMS.md` - LLM å‚æ•°é…ç½®
- `README.md` - é¡¹ç›®æ€»ä½“è¯´æ˜

