# ✨ Ragas 评估指标动态配置功能

## 📋 功能概述

现在您可以通过 Web 界面动态选择需要评估的 Ragas 指标，未选择的指标将跳过计算，大幅节省评估时间！

## 🎯 功能特点

- ✅ **可视化配置**: 通过设置按钮打开友好的配置界面
- ✅ **灵活选择**: 8个指标自由组合（Context Recall 和 Context Precision 必选）
- ✅ **节省时间**: 只评估选中的指标，显著减少响应时间
- ✅ **持久化存储**: 配置自动保存，下次评估时继续使用
- ✅ **双重备份**: 同时保存到服务器和浏览器本地存储

## 🚀 使用方法

### 1. 打开设置界面

在 **Ragas评估** 区域的标题旁边，点击 **齿轮图标** ⚙️ 按钮

```
[ 🤖 Ragas评估 ⚙️ ]  [ 开始评估 ] [ 查看明细 ] [ 保存结果 ]
                  ↑
               点击这里
```

### 2. 选择评估指标

弹框中展示了 **8个 Ragas 指标**，分为两组：

#### 📊 上下文质量指标

| 指标 | 中文名称 | 说明 | 是否可选 |
|------|----------|------|----------|
| **Context Recall** | 上下文召回率 | 检索到的上下文是否包含回答问题所需的所有信息 | ❌ 必选 |
| **Context Precision** | 上下文精确度 | 检索到的上下文中有多少是与查询直接相关的 | ❌ 必选 |
| **Context Entity Recall** | 上下文实体召回率 | 检索上下文中是否包含标准答案的关键实体 | ✅ 可选 |
| **Context Relevance** | 上下文相关性 | 检索到的上下文与用户查询的相关性 | ✅ 可选 |

#### 💬 答案质量指标

| 指标 | 中文名称 | 说明 | 是否可选 |
|------|----------|------|----------|
| **Faithfulness** | 忠实度 | 生成的答案是否忠实于检索到的上下文 | ✅ 可选 |
| **Answer Relevancy** | 答案相关性 | 生成的答案与用户查询的相关程度 | ✅ 可选 |
| **Answer Correctness** | 答案正确性 | 综合评估答案的事实正确性和语义相似性 | ✅ 可选 |
| **Answer Similarity** | 答案相似度 | 使用Embedding计算答案与标准答案的语义相似度 | ✅ 可选 |

### 3. 确认保存

- 选择完成后，点击 **确认** 按钮
- 系统会显示：`配置已保存！已选择 X 个指标`
- 配置立即生效，下次评估时使用新配置

### 4. 运行评估

- 点击 **开始评估** 按钮
- 系统只评估您选中的指标
- 控制台会显示：`✅ 已设置 X 个评估指标: faithfulness, answer_relevancy...`

## 💡 使用建议

### 快速评估（选择 3-4 个指标）

适合快速测试和迭代：

```
✅ Context Recall          (必选)
✅ Context Precision        (必选)
✅ Faithfulness
✅ Answer Relevancy
```

**预计时间**: ~2-3 分钟（50% ⬇️）

### 标准评估（选择 5-6 个指标）

平衡速度和全面性：

```
✅ Context Recall          (必选)
✅ Context Precision        (必选)
✅ Context Relevance
✅ Faithfulness
✅ Answer Relevancy
✅ Answer Correctness
```

**预计时间**: ~3-4 分钟（30% ⬇️）

### 完整评估（全部 8 个指标）

最全面的评估：

```
✅ 所有指标
```

**预计时间**: ~5-6 分钟（基准）

## 📊 性能对比

| 场景 | 指标数量 | 评估时间 | 节省时间 |
|------|----------|----------|----------|
| 快速测试 | 3-4 个 | ~2-3 分钟 | **-50%** ⬇️ |
| 标准评估 | 5-6 个 | ~3-4 分钟 | **-30%** ⬇️ |
| 完整评估 | 8 个 | ~5-6 分钟 | 基准 |

*以100个样本为例，实际时间因数据集大小和网络环境而异

## 🔧 技术实现

### 前端（Web界面）

1. **HTML**: `static/index.html`
   - 设置按钮
   - 配置弹框
   - 指标复选框

2. **CSS**: `static/ragas_settings.css`
   - 弹框样式
   - 复选框样式
   - 响应式设计

3. **JavaScript**: `static/ragas_settings.js`
   - 弹框交互
   - 配置保存/加载
   - API 调用

### 后端（Python）

1. **API接口**: `app.py`
   - `GET /api/ragas/config` - 获取配置
   - `POST /api/ragas/config` - 保存配置

2. **配置管理**: `rag_evaluator.py`
   - `RagasMetricsConfig` 类
   - 配置文件: `ragas_metrics_config.json`
   - 动态指标创建

### 配置文件示例

`ragas_metrics_config.json`:
```json
{
  "enabled_metrics": [
    "context_recall",
    "context_precision",
    "faithfulness",
    "answer_relevancy"
  ],
  "version": "1.0"
}
```

## 🎨 界面预览

### 设置按钮
```
🤖 Ragas评估 ⚙️
              ↑
        悬停时旋转90度
```

### 配置弹框
```
┌─────────────────────────────────────────┐
│  ⚙️  Ragas评估指标配置              ✕  │
├─────────────────────────────────────────┤
│  ℹ️ 选择需要评估的指标，未选择的指标将 │
│     跳过计算，节省评估时间。           │
│                                         │
│  📊 上下文质量指标                      │
│  ☑ Context Recall (必选)               │
│  ☑ Context Precision (必选)            │
│  ☑ Context Entity Recall               │
│  ☑ Context Relevance                   │
│                                         │
│  💬 答案质量指标                        │
│  ☑ Faithfulness                        │
│  ☑ Answer Relevancy                    │
│  ☑ Answer Correctness                  │
│  ☑ Answer Similarity                   │
│                                         │
│  📊 已选择 8 个指标                     │
├─────────────────────────────────────────┤
│            [ 取消 ]  [ ✓ 确认 ]         │
└─────────────────────────────────────────┘
```

## 📝 常见问题

### Q: 为什么 Context Recall 和 Context Precision 不能取消？

A: 这两个是 RAG 评估的核心指标，分别评估召回率（找全）和精确度（找准），是评估检索质量的基础。

### Q: 配置保存在哪里？

A: 
1. **服务器端**: `ragas_metrics_config.json` 文件
2. **浏览器端**: `localStorage` 中的 `ragas_metrics_config` 键

### Q: 服务器重启后配置会丢失吗？

A: 不会。配置保存在 JSON 文件中，重启后会自动加载。

### Q: 可以恢复默认配置吗？

A: 可以删除 `ragas_metrics_config.json` 文件，系统会自动使用默认的全部 8 个指标。

### Q: 配置对历史数据有影响吗？

A: 没有影响。配置只影响新的评估，历史评估结果不会改变。

## 🔄 更新日志

### v1.0 (2025-10-28)

- ✅ 实现指标动态选择功能
- ✅ 添加可视化配置界面
- ✅ 支持配置持久化存储
- ✅ 优化评估性能

## 📞 支持

如遇问题，请检查：

1. **浏览器控制台** (F12) - 查看 JavaScript 错误
2. **服务器日志** - 查看 Python 错误
3. **配置文件** - 确认 `ragas_metrics_config.json` 格式正确

---

**功能状态**: ✅ 已完成并测试  
**最后更新**: 2025-10-28

