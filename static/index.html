<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG评估系统</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/components/navigation.css">
    <link rel="stylesheet" href="/static/ragas_settings.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <p class="subtitle">基于BM25和Ragas的RAG评估平台</p>
                </div>
                <div class="header-center">
                    <div class="dataset-selector">
                        <label for="datasetType" class="dataset-label">
                            <i class="fas fa-database"></i> 选择评估的数据集
                        </label>
                        <select id="datasetType" class="dataset-select" onchange="handleDatasetTypeChange()">
                            <option value="standard">✨ 标准数据集</option>
                            <!-- 动态加载上传的数据集文件 -->
                        </select>
                    </div>
                </div>
                <div class="header-right">
                    <div class="model-info-card qwen-model" id="currentModelDisplay">
                        <i class="fas fa-cloud model-icon"></i> 
                        <span class="model-title">云端Qwen</span>
                        <span class="model-subtitle">text-embedding-v1</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 
            评估明细显示结构说明：
            1. 用户查询 (class="user-query") - 显示用户的问题
            2. 相关分块 (class="relevant-chunks") - 显示评估方法判定的相关分块内容
            3. 不相关分块 (class="chunk-section") - 显示不相关的分块内容
            4. 未召回分块 (class="chunk-section missed-chunk-section") - 显示未召回的分块内容
            
            相关分块显示特点：
            - 使用绿色主题 (background: #e8f5e8, border-left: 3px solid #27ae60)
            - 显示相关分数
            - 在用户查询和不相关分块之间插入显示
            -->
            <!-- BM25评估区域 -->
            <section class="evaluation-section" id="bm25-section">
                <div class="section-header">
                    <h2><i class="fas fa-search"></i> BM25评估</h2>
                    <div class="button-group">
                        <button class="btn btn-primary" id="bm25-evaluate-btn" onclick="runBM25Evaluation()">
                            <i class="fas fa-play"></i> 开始评估
                        </button>
                        <button class="btn btn-secondary" onclick="showBM25Details()">
                            <i class="fas fa-list"></i> 查看明细
                        </button>
                        <button class="btn btn-success" onclick="showSaveDialog('BM25')" id="bm25-save-btn" style="display: none;">
                            <i class="fas fa-save"></i> 保存结果
                        </button>
                        <button class="btn btn-warning" onclick="clearMetricsCache()" title="清除所有指标缓存">
                            <i class="fas fa-trash"></i> 清除缓存
                        </button>
                    </div>
                </div>
                
                <div class="metrics-container" id="bm25-metrics">

                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Recall</h3>
                            <div class="metric-percentage primary" id="bm25-recall-percent">-</div>
                            <div class="metric-value secondary" id="bm25-recall">-</div>
                            <div class="metric-chinese-name">找全</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Precision</h3>
                            <div class="metric-percentage primary" id="bm25-precision-percent">-</div>
                            <div class="metric-value secondary" id="bm25-precision">-</div>
                            <div class="metric-chinese-name">找准</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>F1-Score</h3>
                            <div class="metric-percentage primary" id="bm25-f1-percent">-</div>
                            <div class="metric-value secondary" id="bm25-f1">-</div>
                            <div class="metric-chinese-name">Precision和Recall的调和平均数</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>MRR</h3>
                            <div class="metric-percentage primary" id="bm25-mrr-percent">-</div>
                            <div class="metric-value secondary" id="bm25-mrr">-</div>
                            <div class="metric-chinese-name">第一个相关分块是否靠前</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>MAP</h3>
                            <div class="metric-percentage primary" id="bm25-map-percent">-</div>
                            <div class="metric-value secondary" id="bm25-map">-</div>
                            <div class="metric-chinese-name">每一个相关分块是否都靠前</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>NDCG</h3>
                            <div class="metric-percentage primary" id="bm25-ndcg-percent">-</div>
                            <div class="metric-value secondary" id="bm25-ndcg">-</div>
                            <div class="metric-chinese-name">比MAP更细粒度</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ragas评估区域 -->
            <section class="evaluation-section" id="ragas-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-robot"></i> Ragas评估
                        <button class="btn-icon" id="ragas-settings-btn" onclick="openRagasSettings()" title="配置评估指标">
                            <i class="fas fa-cog"></i>
                        </button>
                        <span class="settings-hint">可设置参与评估的指标</span>
                    </h2>
                    <div class="button-group centered">
                        <button class="btn btn-primary" id="ragas-evaluate-btn" onclick="runRagasEvaluation()">
                            <i class="fas fa-play"></i> 开始评估
                        </button>
                        <button class="btn btn-secondary" id="ragas-details-btn" onclick="showRagasDetails()">
                            <i class="fas fa-list"></i> 查看明细
                        </button>
                        <button class="btn btn-success" onclick="showSaveDialog('RAGAS')" id="ragas-save-btn" style="display: none;">
                            <i class="fas fa-save"></i> 保存结果
                        </button>
                    </div>
                </div>
                
                <div class="metrics-container" id="ragas-metrics">

                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Recall</h3>
                            <div class="metric-percentage primary" id="ragas-recall-percent">-</div>
                            <div class="metric-value secondary" id="ragas-recall">-</div>
                            <div class="metric-chinese-name">找全</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Precision</h3>
                            <div class="metric-percentage primary" id="ragas-precision-percent">-</div>
                            <div class="metric-value secondary" id="ragas-precision">-</div>
                            <div class="metric-chinese-name">找准</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Entity Recall</h3>
                            <div class="metric-percentage primary" id="ragas-entity-recall-percent">-</div>
                            <div class="metric-value secondary" id="ragas-entity-recall">-</div>
                            <div class="metric-chinese-name">关键实体召回率</div>
                        </div>
                    </div>

                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Context Relevance</h3>
                            <div class="metric-percentage primary" id="ragas-context-relevance-percent">-</div>
                            <div class="metric-value secondary" id="ragas-context-relevance">-</div>
                            <div class="metric-chinese-name">与query的相关性</div>
                        </div>
                    </div>
  
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Faithfulness</h3>
                            <div class="metric-percentage primary" id="ragas-faithfulness-percent">-</div>
                            <div class="metric-value secondary" id="ragas-faithfulness">-</div>
                            <div class="metric-chinese-name">忠于上下文</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Answer Relevancy</h3>
                            <div class="metric-percentage primary" id="ragas-relevancy-percent">-</div>
                            <div class="metric-value secondary" id="ragas-relevancy">-</div>
                            <div class="metric-chinese-name">与query的相关性</div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Answer Similarity</h3>
                            <div class="metric-percentage primary" id="ragas-similarity-percent">-</div>
                            <div class="metric-value secondary" id="ragas-similarity">-</div>
                            <div class="metric-chinese-name">与标准答案Embedding相似度</div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-content">
                            <h3>Answer Correctness</h3>
                            <div class="metric-percentage primary" id="ragas-correctness-percent">-</div>
                            <div class="metric-value secondary" id="ragas-correctness">-</div>
                            <div class="metric-chinese-name">与标准答案Embedding+LLM</div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- BM25评估明细区域 -->
            <section class="details-section" id="bm25-details-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-list-alt"></i> BM25评估明细</h2>
                </div>
                <div class="details-stats" id="bm25-details-stats">
                    <!-- 统计信息 -->
                </div>
                <div class="details-content" id="bm25-details-content">
                    <!-- 动态加载内容 -->
                </div>
            </section>

            <!-- Ragas评估明细区域 -->
            <section class="details-section" id="ragas-details-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-list-alt"></i> Ragas评估明细</h2>
                    <button class="btn btn-secondary" onclick="hideRagasDetails()">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                </div>
                <div class="details-stats" id="ragas-details-stats">
                    <!-- 统计信息 -->
                </div>
                <div class="details-summary" id="ragas-details-summary">
                    <!-- 汇总信息 -->
                </div>
                <div class="details-content" id="ragas-details-content">
                    <!-- 动态加载内容 -->
                    <!-- 
                    示例结构（实际内容由JavaScript动态生成）：
                    <div class="sample-item">
                        <div class="sample-header">
                            <div class="sample-title">样本1</div>
                            <div class="sample-score">行 1</div>
                        </div>
                        
                        <div class="user-query">
                            <strong>用户查询:</strong>
                            用户的问题内容
                        </div>
                        
                        <!-- 相关分块显示区域 - Ragas方法判定 -->
                        <div class="relevant-chunks">
                            <h4><i class="fas fa-check-circle"></i> 相关分块 (1个)</h4>
                            <div class="relevant-chunk-item">
                                这是Ragas方法判定的相关分块内容...
                                <br><small style="color: #27ae60;">相关分数: 0.9200</small>
                            </div>
                        </div>
                        
                        <div class="chunk-section">
                            <h4><i class="fas fa-times-circle"></i> 不相关分块 (1个)</h4>
                            <div class="chunk-item">
                                不相关的内容...
                            </div>
                        </div>
                        
                        <div class="chunk-section missed-chunk-section">
                            <h4><i class="fas fa-exclamation-triangle"></i> 未召回分块 (1个)</h4>
                            <div class="chunk-item">
                                未召回的内容...
                            </div>
                        </div>
                    </div>
                    -->
                </div>
            </section>
        </main>

        <!-- 加载提示 -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loading-text">正在评估中...</p>
            </div>
        </div>


        <!-- 保存评估结果弹框 -->
        <div class="modal" id="saveModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>保存评估结果</h3>
                    <button class="modal-close" onclick="closeSaveDialog()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="evaluationDescription">评估描述：</label>
                        <textarea id="evaluationDescription" placeholder="请输入评估描述（可选）" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>评估类型：</label>
                        <span id="saveEvaluationType" class="evaluation-type-badge"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeSaveDialog()">取消</button>
                    <button class="btn btn-primary" onclick="saveEvaluation()">保存</button>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div class="toast" id="toast">
            <div class="toast-content">
                <i class="toast-icon"></i>
                <span class="toast-message"></span>
            </div>
        </div>
    </div>

    <!-- 设置窗口 -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h2><i class="fas fa-cog"></i> 系统设置</h2>
                <button class="close-btn" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-body">
                <div class="setting-group">
                    <h3><i class="fas fa-brain"></i> Embedding模型设置</h3>
                    <div class="setting-item">
                        <label class="radio-label">
                            <input type="radio" name="embeddingModel" value="qwen" checked>
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>云端Qwen模型</strong>
                                <small>使用云端Qwen embedding模型（当前默认）</small>
                            </div>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="radio-label">
                            <input type="radio" name="embeddingModel" value="ollama">
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>本地Embedding模型，云端LLM模型</strong>
                                <small>使用本地安装的Ollama embedding模型</small>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="setting-group" id="qwenSettings" style="display: none;">
                    <h3><i class="fas fa-key"></i> Qwen API配置</h3>
                    <div class="setting-item">
                        <label for="qwenApiKey">请输入Qwen的key：</label>
                        <input type="password" id="qwenApiKey" placeholder="请输入qwen的key" class="api-key-input">
                    </div>
                </div>
                <div class="setting-group" id="ollamaSettings" style="display: none;">
                    <h3><i class="fas fa-server"></i> Ollama配置</h3>
                    <div class="setting-item">
                        <label for="ollamaUrl">Ollama服务地址:</label>
                        <input type="text" id="ollamaUrl" value="http://localhost:11434" placeholder="http://localhost:11434">
                    </div>
                    <div class="setting-item">
                        <label for="ollamaModel">Embedding模型名称:</label>
                        <input type="text" id="ollamaModel" value="embeddinggemma:300m" placeholder="embeddinggemma:300m">
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 文档上传窗口（统一使用通用弹框样式） -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> 上传待评测的文档</h3>
                <button class="modal-close" onclick="closeUploadDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="uploadArea" style="border:2px dashed #ddd;border-radius:10px;padding:20px;text-align:center;margin-bottom:16px;">
                    <div class="upload-icon" style="font-size:32px;color:#f39c12;margin-bottom:10px;">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <h3 style="margin:0 0 8px 0;">点击或拖拽文件到此处上传</h3>
                        <p style="margin:0 0 12px 0;color:#666;">支持 .xlsx 格式的Excel文档</p>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx" style="display:none;">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> 选择文件
                    </button>
                </div>
                <!-- 下载模版区域 -->
                <div class="template-download-area" style="background: linear-gradient(135deg, #e8f4fd 0%, #d5e8f7 100%); border: 2px solid #3498db; border-radius: 10px; padding: 15px; margin-bottom: 16px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <i class="fas fa-file-excel" style="font-size: 2rem; color: #27ae60;"></i>
                        <div style="text-align: left; flex: 1; min-width: 200px;">
                            <h4 style="margin: 0 0 5px 0; color: #2c3e50;">
                                <i class="fas fa-download"></i> 需要数据集模版？
                            </h4>
                            <p style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">
                                下载标准数据集模版，了解所需的字段格式
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <a href="/api/dataset/download-template" download="standardDataset.xlsx" class="btn btn-success" style="text-decoration: none; white-space: nowrap;">
                                <i class="fas fa-download"></i> 下载模版
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="upload-info" style="background:#f8f9fa;border-radius:10px;padding:15px;">
                    <h4 style="margin:0 0 10px 0;">上传说明</h4>
                    <div class="info-content">
                        <p><strong>注：</strong></p>
                        <ol>
                            <li>只能上传excel文档。</li>
                            <li>文档名称：<code>standardDataset.xlsx</code>，不能变。</li>
                            <li>文档字段说明：</li>
                        </ol>
                        <ul class="field-list">
                            <li><strong>user_input</strong>：用户的query</li>
                            <li><strong>retrieved_contexts</strong>：rag送到context的分块，分块与分块用空行隔开【需要导入rag的分块】</li>
                            <li><strong>response</strong>：LLM基于RAG的回答【需要导入rag的回答】</li>
                            <li><strong>reference_contexts</strong>：基于文档的标准答案的分块，可以用AI生成【人工review标注】</li>
                            <li><strong>reference</strong>：基于文档的标准回复，可以用AI生成【人工review标注】</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadDialog()">取消</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()" disabled>
                    <i class="fas fa-upload"></i> 上传文档
                </button>
            </div>
        </div>
    </div>

    <!-- Ragas指标配置弹框 -->
    <div id="ragas-settings-modal" class="modal" style="display: none;">
        <div class="modal-content ragas-settings-modal">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Ragas评估指标配置</h3>
                <span class="close" onclick="closeRagasSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="settings-description">
                    <i class="fas fa-info-circle"></i> 
                    选择需要评估的指标，未选择的指标将跳过计算，节省评估时间。
                </p>
                <div class="metrics-selector">
                    <div class="metric-group">
                        <h4><i class="fas fa-database"></i> 上下文质量指标</h4>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-context_recall" value="context_recall" checked disabled>
                                <span class="metric-name">Context Recall</span>
                                <span class="metric-cn-name">上下文召回率</span>
                                <span class="required-badge">必选</span>
                            </label>
                            <p class="metric-desc">评估检索到的上下文是否包含回答问题所需的所有信息</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-context_precision" value="context_precision" checked disabled>
                                <span class="metric-name">Context Precision</span>
                                <span class="metric-cn-name">上下文精确度</span>
                                <span class="required-badge">必选</span>
                            </label>
                            <p class="metric-desc">评估检索到的上下文中有多少是与查询直接相关的</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-context_entity_recall" value="context_entity_recall" checked>
                                <span class="metric-name">Context Entity Recall</span>
                                <span class="metric-cn-name">上下文实体召回率</span>
                            </label>
                            <p class="metric-desc">评估检索上下文中是否包含标准答案的关键实体</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-context_relevance" value="context_relevance" checked>
                                <span class="metric-name">Context Relevance</span>
                                <span class="metric-cn-name">上下文相关性</span>
                            </label>
                            <p class="metric-desc">评估检索到的上下文与用户查询的相关性</p>
                        </div>
                    </div>
                    
                    <div class="metric-group">
                        <h4><i class="fas fa-comment-dots"></i> 答案质量指标</h4>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-faithfulness" value="faithfulness">
                                <span class="metric-name">Faithfulness</span>
                                <span class="metric-cn-name">忠实度</span>
                            </label>
                            <p class="metric-desc">评估生成的答案是否忠实于检索到的上下文</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-answer_relevancy" value="answer_relevancy">
                                <span class="metric-name">Answer Relevancy</span>
                                <span class="metric-cn-name">答案相关性</span>
                            </label>
                            <p class="metric-desc">评估生成的答案与用户查询的相关程度</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-answer_correctness" value="answer_correctness">
                                <span class="metric-name">Answer Correctness</span>
                                <span class="metric-cn-name">答案正确性</span>
                            </label>
                            <p class="metric-desc">综合评估答案的事实正确性和语义相似性</p>
                        </div>
                        <div class="metric-checkbox-item">
                            <label>
                                <input type="checkbox" id="metric-answer_similarity" value="answer_similarity">
                                <span class="metric-name">Answer Similarity</span>
                                <span class="metric-cn-name">答案相似度</span>
                            </label>
                            <p class="metric-desc">使用Embedding计算答案与标准答案的语义相似度</p>
                        </div>
                    </div>
                </div>
                <div class="settings-summary">
                    <i class="fas fa-chart-bar"></i>
                    已选择 <span id="selected-metrics-count">4</span> 个指标
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRagasSettings()">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="btn btn-primary" onclick="saveRagasSettings()">
                    <i class="fas fa-check"></i> 确认
                </button>
            </div>
        </div>
    </div>

    <script src="/static/ragas_settings.js"></script>
    <script src="/static/script.js"></script>
    <script src="/static/components/navigation.js"></script>
</body>
</html>
