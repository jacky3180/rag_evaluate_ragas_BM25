<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²æ•°æ®åˆ†æ - RAGè¯„ä¼°ç³»ç»Ÿ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/components/navigation.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 3px solid;
            border-image: linear-gradient(135deg, #667eea, #764ba2) 1;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.1rem;
            color: #7f8c8d;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 10px;
        }
        
        .loading i.fa-info-circle {
            color: #3498db;
            margin-right: 8px;
        }

        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .stats-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }

        /* æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨æ ·å¼ */
        .date-range-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .date-input-group label {
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .date-input {
            padding: 8px 12px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
            width: auto;
            min-width: 150px;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .apply-date-btn, .reset-date-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .apply-date-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .apply-date-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .reset-date-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
        }

        .reset-date-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.6);
        }

        /* åˆå§‹æç¤ºæ ·å¼ */
        .initial-hint {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(41, 128, 185, 0.1));
            border: 2px dashed #3498db;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
            text-align: center;
            color: #2c3e50;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            animation: fadeIn 0.5s ease-in;
        }
        
        .initial-hint i {
            color: #f39c12;
            font-size: 1.2rem;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç­›é€‰çŠ¶æ€æ ·å¼ */
        .filter-status {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: slideIn 0.3s ease;
        }

        .filter-status i {
            margin-right: 8px;
        }

        .clear-filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ•°æ®è¡¨æ ¼æ ·å¼ */
        .data-tables-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table-container h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border-radius: 5px 5px 0 0;
        }

        .data-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .data-table tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .loading-cell {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }
        
        .loading-cell i.fa-info-circle {
            color: #3498db;
            margin-right: 8px;
        }

        .percentage-cell {
            font-weight: bold;
            color: #27ae60;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ
        </button>

        <div class="header">
            <div class="stats-summary">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-chart-bar"></i> æ•°æ®æ¦‚è§ˆ
                </h3>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalEvaluations">-</div>
                        <div class="stat-label">æ€»è¯„ä¼°æ¬¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgPrecision">-</div>
                        <div class="stat-label">å¹³å‡å‡†ç¡®ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgRecall">-</div>
                        <div class="stat-label">å¹³å‡å¬å›ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="latestUpdate">-</div>
                        <div class="stat-label">æœ€æ–°æ›´æ–°</div>
                    </div>
                </div>
            </div>



            <h1><i class="fas fa-chart-line"></i> å†å²æ•°æ®åˆ†æ</h1>
            <p>RAGè¯„ä¼°ç³»ç»Ÿå†å²æŒ‡æ ‡è¶‹åŠ¿åˆ†æ</p>
            
            <!-- æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
            <div class="date-range-selector">
                <div class="date-input-group">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ:</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="date-input-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
                <button class="apply-date-btn" onclick="applyDateFilter()">
                    <i class="fas fa-filter"></i> åº”ç”¨ç­›é€‰
                </button>
                <button class="reset-date-btn" onclick="resetDateFilter()">
                    <i class="fas fa-undo"></i> é‡ç½®
                </button>
            </div>
            
            <!-- åˆå§‹æç¤º -->
            <div id="initial-hint" class="initial-hint">
                <i class="fas fa-lightbulb"></i>
                æç¤ºï¼šè¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åï¼Œç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å†å²æ•°æ®åˆ†æ
            </div>
        </div>

        
        <!-- æ•°æ®è¡¨æ ¼æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="data-tables-container">
            <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">
                <i class="fas fa-table"></i> åŸå§‹æ•°æ®è¡¨æ ¼
            </h3>
            
            <div class="tables-grid">
                <!-- BM25 Precision è¡¨æ ¼ -->
                <div class="table-container">
                    <h4><i class="fas fa-bullseye"></i> BM25-Precision æ•°æ®</h4>
                    <div class="table-wrapper">
                        <table class="data-table" id="bm25PrecisionTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>å‡†ç¡®ç‡</th>
                                    <th>ç™¾åˆ†æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading-cell">
                                    <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹æ•°æ®
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- BM25 Recall è¡¨æ ¼ -->
                <div class="table-container">
                    <h4><i class="fas fa-search"></i> BM25-Recall æ•°æ®</h4>
                    <div class="table-wrapper">
                        <table class="data-table" id="bm25RecallTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>å¬å›ç‡</th>
                                    <th>ç™¾åˆ†æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading-cell">
                                    <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹æ•°æ®
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ragas Precision è¡¨æ ¼ -->
                <div class="table-container">
                    <h4><i class="fas fa-bullseye"></i> Ragas-Precision æ•°æ®</h4>
                    <div class="table-wrapper">
                        <table class="data-table" id="ragasPrecisionTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>å‡†ç¡®ç‡</th>
                                    <th>ç™¾åˆ†æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading-cell">
                                    <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹æ•°æ®
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ragas Recall è¡¨æ ¼ -->
                <div class="table-container">
                    <h4><i class="fas fa-search"></i> Ragas-Recall æ•°æ®</h4>
                    <div class="table-wrapper">
                        <table class="data-table" id="ragasRecallTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ—¶é—´</th>
                                    <th>å¬å›ç‡</th>
                                    <th>ç™¾åˆ†æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading-cell">
                                    <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹æ•°æ®
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="charts-grid">
            <!-- BM25 Precision Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-bullseye"></i> BM25-Precision
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="bm25PrecisionLoading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="bm25PrecisionChart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- BM25 Recall Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-search"></i> BM25-Recall
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="bm25RecallLoading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="bm25RecallChart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- BM25 F1-Score Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i> BM25-F1-Score
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="bm25F1Loading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="bm25F1Chart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- BM25 NDCG Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-trophy"></i> BM25-NDCG
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="bm25NDCGLoading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="bm25NDCGChart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- Ragas Precision Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-bullseye"></i> Ragas-Precision
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="ragasPrecisionLoading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="ragasPrecisionChart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>

            <!-- Ragas Recall Chart -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-search"></i> Ragas-Recall
                </div>
                <div class="chart-wrapper">
                    <div class="loading" id="ragasRecallLoading">
                        <i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨
                    </div>
                    <div id="ragasRecallChart" style="display: none; width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æ•°æ®å’Œç­›é€‰çŠ¶æ€
        let originalData = {
            bm25Precision: null,
            bm25Recall: null,
            bm25F1: null,
            bm25NDCG: null,
            ragasPrecision: null,
            ragasRecall: null
        };
        let isDateFiltered = false;
        
        // å‰ç«¯æ•°æ®ç¼“å­˜ï¼ˆå‡å°‘é‡å¤APIè°ƒç”¨ï¼‰
        let dataCache = {
            allHistory: null,
            timestamp: null,
            ttl: 300000 // 5åˆ†é’Ÿç¼“å­˜
        };
        
        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
        function isCacheValid() {
            if (!dataCache.allHistory || !dataCache.timestamp) {
                return false;
            }
            return (Date.now() - dataCache.timestamp) < dataCache.ttl;
        }
        
        // æ¸…é™¤å‰ç«¯ç¼“å­˜
        function clearFrontendCache() {
            dataCache.allHistory = null;
            dataCache.timestamp = null;
            console.log('ğŸ—‘ï¸  å‰ç«¯ç¼“å­˜å·²æ¸…é™¤');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®
            initializeDateInputs();
            showInitialMessage();
        });

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = 'http://localhost:8000/';
        }

        // æ˜¾ç¤ºåˆå§‹æç¤ºä¿¡æ¯
        function showInitialMessage() {
            // è®¾ç½®ç»Ÿè®¡æ•°æ®çš„åˆå§‹æç¤º
            document.getElementById('totalEvaluations').textContent = '-';
            document.getElementById('avgPrecision').textContent = '-';
            document.getElementById('avgRecall').textContent = '-';
            document.getElementById('latestUpdate').textContent = 'è¯·é€‰æ‹©æ—¥æœŸå¹¶æŸ¥è¯¢';
            
            // æ˜¾ç¤ºåˆå§‹æç¤ºæ¡†
            const hintElement = document.getElementById('initial-hint');
            if (hintElement) {
                hintElement.style.display = 'flex';
            }
        }
        
        // éšè—åˆå§‹æç¤º
        function hideInitialHint() {
            const hintElement = document.getElementById('initial-hint');
            if (hintElement) {
                hintElement.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºåˆå§‹æç¤º
        function showInitialHint() {
            const hintElement = document.getElementById('initial-hint');
            if (hintElement) {
                hintElement.style.display = 'flex';
            }
        }

        // åŠ è½½æ‰€æœ‰å›¾è¡¨å’Œæ•°æ®è¡¨æ ¼ï¼ˆä¼˜åŒ–ç‰ˆ - ä½¿ç”¨æ‰¹é‡APIï¼‰
        async function loadAllCharts() {
            try {
                console.log('ğŸ“Š å¼€å§‹æ‰¹é‡åŠ è½½å›¾è¡¨æ•°æ®...');
                const startTime = performance.now();
                
                // ä½¿ç”¨æ‰¹é‡APIä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®
                const response = await fetch('/api/history/all');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // å­˜å‚¨åˆ°åŸå§‹æ•°æ®
                    originalData.bm25Precision = data.bm25.precision;
                    originalData.bm25Recall = data.bm25.recall;
                    originalData.bm25F1 = data.bm25.f1;
                    originalData.bm25NDCG = data.bm25.ndcg;
                    originalData.ragasPrecision = data.ragas.precision;
                    originalData.ragasRecall = data.ragas.recall;
                    
                    // æ›´æ–°å‰ç«¯ç¼“å­˜
                    dataCache.allHistory = data;
                    dataCache.timestamp = Date.now();
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰å¹¶æ¸²æŸ“å›¾è¡¨
                    await renderAllChartsFromData();
                    
                    // åŠ è½½ç»Ÿè®¡æ•°æ®å’Œè¡¨æ ¼
                    await Promise.all([
                        loadStatsSummary(),
                        loadAllTables()
                    ]);
                    
                    const endTime = performance.now();
                    console.log(`âœ… å›¾è¡¨åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                } else {
                    throw new Error(result.message || 'æ‰¹é‡åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ æ‰¹é‡åŠ è½½å›¾è¡¨å¤±è´¥:', error);
                // å›é€€åˆ°å•ç‹¬åŠ è½½
                console.log('â†©ï¸  å›é€€åˆ°å•ç‹¬åŠ è½½æ¨¡å¼...');
                await loadAllChartsIndividually();
            }
        }
        
        // å›é€€æ–¹æ³•ï¼šå•ç‹¬åŠ è½½æ¯ä¸ªå›¾è¡¨
        async function loadAllChartsIndividually() {
            try {
                await Promise.all([
                    loadBM25PrecisionChart(),
                    loadBM25RecallChart(),
                    loadBM25F1Chart(),
                    loadBM25NDCGChart(),
                    loadRagasPrecisionChart(),
                    loadRagasRecallChart(),
                    loadStatsSummary(),
                    loadAllTables()
                ]);
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨å¤±è´¥:', error);
                showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // ä»å·²æœ‰æ•°æ®æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
        async function renderAllChartsFromData() {
            const startDate = isDateFiltered ? document.getElementById('startDate').value : null;
            const endDate = isDateFiltered ? document.getElementById('endDate').value : null;
            
            // åº”ç”¨ç­›é€‰
            const bm25Precision = isDateFiltered ? filterDataByDate(originalData.bm25Precision, startDate, endDate) : originalData.bm25Precision;
            const bm25Recall = isDateFiltered ? filterDataByDate(originalData.bm25Recall, startDate, endDate) : originalData.bm25Recall;
            const bm25F1 = isDateFiltered ? filterDataByDate(originalData.bm25F1, startDate, endDate) : originalData.bm25F1;
            const bm25NDCG = isDateFiltered ? filterDataByDate(originalData.bm25NDCG, startDate, endDate) : originalData.bm25NDCG;
            const ragasPrecision = isDateFiltered ? filterDataByDate(originalData.ragasPrecision, startDate, endDate) : originalData.ragasPrecision;
            const ragasRecall = isDateFiltered ? filterDataByDate(originalData.ragasRecall, startDate, endDate) : originalData.ragasRecall;
            
            // å¹¶è¡Œæ¸²æŸ“æ‰€æœ‰å›¾è¡¨
            await Promise.all([
                createPlotlyChart('bm25PrecisionChart', 'BM25-Precision', bm25Precision, '#667eea'),
                createPlotlyChart('bm25RecallChart', 'BM25-Recall', bm25Recall, '#e74c3c'),
                createPlotlyChart('bm25F1Chart', 'BM25-F1-Score', bm25F1, '#9b59b6'),
                createPlotlyChart('bm25NDCGChart', 'BM25-NDCG', bm25NDCG, '#f39c12'),
                createPlotlyChart('ragasPrecisionChart', 'Ragas-Precision', ragasPrecision, '#27ae60'),
                createPlotlyChart('ragasRecallChart', 'Ragas-Recall', ragasRecall, '#f39c12')
            ]);
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®è¡¨æ ¼
        async function loadAllTables() {
            try {
                await Promise.all([
                    loadBM25PrecisionTable(),
                    loadBM25RecallTable(),
                    loadRagasPrecisionTable(),
                    loadRagasRecallTable()
                ]);
            } catch (error) {
                console.error('åŠ è½½è¡¨æ ¼å¤±è´¥:', error);
            }
        }

        // åŠ è½½BM25 Precisionå›¾è¡¨
        async function loadBM25PrecisionChart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/bm25/precision');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.bm25Precision = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('bm25PrecisionChart', 'BM25-Precision', filteredData, '#667eea');
                } else {
                    showChartError('bm25PrecisionLoading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½BM25 Precisionå›¾è¡¨å¤±è´¥:', error);
                showChartError('bm25PrecisionLoading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½BM25 Recallå›¾è¡¨
        async function loadBM25RecallChart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/bm25/recall');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.bm25Recall = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('bm25RecallChart', 'BM25-Recall', filteredData, '#e74c3c');
                } else {
                    showChartError('bm25RecallLoading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½BM25 Recallå›¾è¡¨å¤±è´¥:', error);
                showChartError('bm25RecallLoading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½BM25 F1-Scoreå›¾è¡¨
        async function loadBM25F1Chart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/bm25/f1');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.bm25F1 = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('bm25F1Chart', 'BM25-F1-Score', filteredData, '#9b59b6');
                } else {
                    showChartError('bm25F1Loading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½BM25 F1-Scoreå›¾è¡¨å¤±è´¥:', error);
                showChartError('bm25F1Loading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½BM25 NDCGå›¾è¡¨
        async function loadBM25NDCGChart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/bm25/ndcg');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.bm25NDCG = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('bm25NDCGChart', 'BM25-NDCG', filteredData, '#f39c12');
                } else {
                    showChartError('bm25NDCGLoading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½BM25 NDCGå›¾è¡¨å¤±è´¥:', error);
                showChartError('bm25NDCGLoading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½Ragas Precisionå›¾è¡¨
        async function loadRagasPrecisionChart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/ragas/precision');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.ragasPrecision = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('ragasPrecisionChart', 'Ragas-Precision', filteredData, '#27ae60');
                } else {
                    showChartError('ragasPrecisionLoading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½Ragas Precisionå›¾è¡¨å¤±è´¥:', error);
                showChartError('ragasPrecisionLoading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½Ragas Recallå›¾è¡¨
        async function loadRagasRecallChart() {
            try {
                // æ€»æ˜¯è·å–æœ€æ–°æ•°æ®ä»¥ç¡®ä¿ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
                const response = await fetch('/api/history/ragas/recall');
                const data = await response.json();
                
                if (data.success) {
                    // å­˜å‚¨åŸå§‹æ•°æ®
                    originalData.ragasRecall = data.data.history;
                    
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    createPlotlyChart('ragasRecallChart', 'Ragas-Recall', filteredData, '#f39c12');
                } else {
                    showChartError('ragasRecallLoading', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½Ragas Recallå›¾è¡¨å¤±è´¥:', error);
                showChartError('ragasRecallLoading', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½ç»Ÿè®¡æ¦‚è§ˆ
        async function loadStatsSummary() {
            try {
                const response = await fetch('/api/history/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateStatsSummary(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ¦‚è§ˆå¤±è´¥:', error);
            }
        }

        // åˆ›å»ºPlotlyå›¾è¡¨
        function createPlotlyChart(containerId, title, data, color) {
            const container = document.getElementById(containerId);
            const loading = document.getElementById(containerId.replace('Chart', 'Loading'));
            
            // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            loading.style.display = 'none';
            container.style.display = 'block';
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #7f8c8d;">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem;">æš‚æ— å†å²æ•°æ®</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">è¯·å…ˆè¿›è¡Œä¸€äº›è¯„ä¼°ä»¥ç”Ÿæˆæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            // æ•°æ®é¢„å¤„ç†ï¼šæŒ‰æ—¶é—´æ’åº
            let processedData = data
                .filter(item => item.created_at && item.value !== null && item.value !== undefined)
                .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            // æ ¹æ®å›¾è¡¨ç±»å‹å†³å®šæ˜¯å¦å»é‡
            let finalData;
            const isRagasChart = title.includes('Ragas') || title.includes('RAGAS');
            
            if (isRagasChart) {
                // Ragaså›¾è¡¨ï¼šæ°¸è¿œä¸å»é‡ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                finalData = processedData;
            } else if (isDateFiltered) {
                // BM25å›¾è¡¨ + åº”ç”¨æ—¥æœŸç­›é€‰æ—¶ï¼šæ˜¾ç¤ºæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®ï¼Œä¸å»é‡
                finalData = processedData;
            } else {
                // BM25å›¾è¡¨ + æœªåº”ç”¨ç­›é€‰æ—¶ï¼šè¿›è¡Œå»é‡ï¼ˆåŒä¸€å¤©åªæ˜¾ç¤ºæœ€æ–°çš„ï¼‰
                const deduplicatedData = processedData.reduce((acc, current) => {
                    const dateKey = new Date(current.created_at).toISOString().split('T')[0];
                    if (!acc[dateKey] || new Date(current.created_at) > new Date(acc[dateKey].created_at)) {
                        acc[dateKey] = current;
                    }
                    return acc;
                }, {});
                finalData = Object.values(deduplicatedData);
            }
            
            // å‡†å¤‡æ•°æ®
            const dates = finalData.map(item => new Date(item.created_at));
            const values = finalData.map(item => parseFloat((item.value * 100).toFixed(2)));
            
            // è®¡ç®—æ—¥æœŸèŒƒå›´ä»¥ç¡®å®šæœ€ä½³æ˜¾ç¤ºæ ¼å¼
            const dateRange = getDateRange(dates);
            const dateFormat = getOptimalDateFormat(dateRange);
            
            // è°ƒè¯•ä¿¡æ¯
            console.log(`${title} å›¾è¡¨æ•°æ®:`, {
                originalDataCount: data.length,
                finalDataCount: finalData.length,
                isDateFiltered: isDateFiltered,
                dateRange: dateRange,
                dateFormat: dateFormat,
                dates: dates,
                values: values
            });
            
            // åˆ›å»ºæ‚¬åœæ–‡æœ¬
            const hoverText = finalData.map((item, index) => {
                const date = new Date(item.created_at);
                const formattedDate = formatDateForHover(date, dateRange);
                return `${title}<br>æ—¶é—´: ${formattedDate}<br>æ•°å€¼: ${(item.value * 100).toFixed(2)}%`;
            });
            
            const plotData = [{
                x: dates.map((_, index) => index), // ä½¿ç”¨ç´¢å¼•ä½œä¸ºxåæ ‡ï¼Œç¡®ä¿ç­‰é—´è·
                y: values,
                type: 'scatter',
                mode: 'lines+markers+text',
                name: title,
                line: {
                    color: color,
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    color: color,
                    size: 10,
                    line: {
                        color: '#fff',
                        width: 2
                    }
                },
                text: values.map(v => v.toFixed(1) + '%'),
                textposition: 'top center',
                textfont: {
                    color: color,
                    size: 10,
                    family: 'Arial, sans-serif'
                },
                hovertemplate: '%{hovertext}<extra></extra>',
                hovertext: hoverText
            }];
            
            const layout = {
                title: {
                    text: title,
                    font: {
                        size: 16,
                        color: '#2c3e50'
                    }
                },
                xaxis: {
                    title: 'æ—¶é—´',
                    titlefont: {
                        size: 14,
                        color: '#2c3e50'
                    },
                    tickfont: {
                        size: 10,
                        color: '#7f8c8d'
                    },
                    gridcolor: 'rgba(0,0,0,0.1)',
                    showgrid: true,
                    type: 'linear', // ä½¿ç”¨çº¿æ€§æ¨¡å¼ï¼Œç­‰é—´è·æ˜¾ç¤º
                    tickangle: -90, // çºµå‘æ˜¾ç¤ºæ ‡ç­¾
                    tickmode: 'array', // ä½¿ç”¨æ•°ç»„æ¨¡å¼
                    tickvals: dates.map((_, index) => index), // ä½¿ç”¨ç´¢å¼•ä½œä¸ºåˆ»åº¦å€¼ï¼Œç¡®ä¿ç­‰é—´è·
                    ticktext: dates.map(date => {
                        const d = new Date(date);
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const hours = String(d.getHours()).padStart(2, '0');
                        const minutes = String(d.getMinutes()).padStart(2, '0');
                        return `${month}-${day} ${hours} ${minutes}`;
                    }),
                    range: [-0.5, finalData.length - 0.5] // è®¾ç½®èŒƒå›´ï¼Œç¡®ä¿æ•°æ®ç‚¹å±…ä¸­
                },
                yaxis: {
                    title: 'ç™¾åˆ†æ¯” (%)',
                    titlefont: {
                        size: 14,
                        color: '#2c3e50'
                    },
                    tickfont: {
                        size: 12,
                        color: '#7f8c8d'
                    },
                    gridcolor: 'rgba(0,0,0,0.1)',
                    showgrid: true,
                    range: [-5, 110], // ä¸ºæ•°æ®ç‚¹å’Œæ•°å€¼æ ‡ç­¾ç•™å‡ºæ›´å¤šç©ºé—´
                    tickformat: '.1f' // æ˜¾ç¤ºä¸€ä½å°æ•°
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: {
                    l: 60,
                    r: 30,
                    t: 80,
                    b: 100 // ä¸ºçºµå‘æ ‡ç­¾ç•™å‡ºè¶³å¤Ÿç©ºé—´
                },
                showlegend: false,
                hovermode: 'closest'
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'toImage', 'sendDataToCloud', 'toggleSpikelines', 'hoverClosestCartesian', 'hoverCompareCartesian'],
                displaylogo: false,
                // æ€§èƒ½ä¼˜åŒ–é…ç½®
                staticPlot: false,  // ä¿æŒäº¤äº’æ€§
                doubleClick: 'reset',  // åŒå‡»é‡ç½®
                showTips: false,  // å…³é—­æç¤º
                // å‡å°‘é‡ç»˜æ¬¡æ•°
                editable: false,
                scrollZoom: false
            };
            
            // åˆ›å»ºå›¾è¡¨ï¼ˆä½¿ç”¨reactè€Œä¸æ˜¯newPlotå¯ä»¥æ›´å¿«åœ°æ›´æ–°ï¼‰
            if (document.getElementById(container).data) {
                // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œä½¿ç”¨reactæ›´æ–°ï¼ˆæ›´å¿«ï¼‰
                Plotly.react(container, plotData, layout, config);
            } else {
                // é¦–æ¬¡åˆ›å»ºå›¾è¡¨
                Plotly.newPlot(container, plotData, layout, config);
            }
        }

        // æ˜¾ç¤ºå›¾è¡¨é”™è¯¯
        function showChartError(loadingId, message) {
            const loading = document.getElementById(loadingId);
            loading.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            loading.style.color = '#e74c3c';
        }

        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        function updateStatsSummary(stats) {
            document.getElementById('totalEvaluations').textContent = stats.total_evaluations || 0;
            document.getElementById('avgPrecision').textContent = 
                stats.avg_precision ? (stats.avg_precision * 100).toFixed(1) + '%' : '-';
            document.getElementById('avgRecall').textContent = 
                stats.avg_recall ? (stats.avg_recall * 100).toFixed(1) + '%' : '-';
            document.getElementById('latestUpdate').textContent = 
                stats.latest_update ? new Date(stats.latest_update).toLocaleDateString() : '-';
        }

        // åŠ è½½BM25 Precisionè¡¨æ ¼
        async function loadBM25PrecisionTable() {
            try {
                const response = await fetch('/api/history/bm25/precision');
                const data = await response.json();
                
                if (data.success) {
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    populateTable('bm25PrecisionTable', filteredData, 'å‡†ç¡®ç‡');
                } else {
                    showTableError('bm25PrecisionTable', data.message);
                }
            } catch (error) {
                showTableError('bm25PrecisionTable', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½BM25 Recallè¡¨æ ¼
        async function loadBM25RecallTable() {
            try {
                const response = await fetch('/api/history/bm25/recall');
                const data = await response.json();
                
                if (data.success) {
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    populateTable('bm25RecallTable', filteredData, 'å¬å›ç‡');
                } else {
                    showTableError('bm25RecallTable', data.message);
                }
            } catch (error) {
                showTableError('bm25RecallTable', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½Ragas Precisionè¡¨æ ¼
        async function loadRagasPrecisionTable() {
            try {
                const response = await fetch('/api/history/ragas/precision');
                const data = await response.json();
                
                if (data.success) {
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    populateTable('ragasPrecisionTable', filteredData, 'å‡†ç¡®ç‡');
                } else {
                    showTableError('ragasPrecisionTable', data.message);
                }
            } catch (error) {
                showTableError('ragasPrecisionTable', 'åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½Ragas Recallè¡¨æ ¼
        async function loadRagasRecallTable() {
            try {
                const response = await fetch('/api/history/ragas/recall');
                const data = await response.json();
                
                if (data.success) {
                    // åº”ç”¨æ—¥æœŸç­›é€‰
                    let filteredData = data.data.history;
                    if (isDateFiltered) {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        filteredData = filterDataByDate(data.data.history, startDate, endDate);
                    }
                    
                    populateTable('ragasRecallTable', filteredData, 'å¬å›ç‡');
                } else {
                    showTableError('ragasRecallTable', data.message);
                }
            } catch (error) {
                showTableError('ragasRecallTable', 'åŠ è½½å¤±è´¥');
            }
        }

        // å¡«å……è¡¨æ ¼æ•°æ®
        function populateTable(tableId, data, metricType) {
            console.log("populateTable è¢«è°ƒç”¨:", {tableId, data, metricType});
            
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            
            if (!data || data.length === 0) {
                console.log("æ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºæš‚æ— æ•°æ®");
                tbody.innerHTML = '<tr><td colspan="4" class="loading-cell">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            // æ•°æ®é¢„å¤„ç†ï¼šæŒ‰æ—¶é—´æ’åº
            let processedData = data
                .filter(item => {
                    const isValid = item.created_at && item.value !== null && item.value !== undefined;
                    console.log(`è¿‡æ»¤æ•°æ®é¡¹:`, item, "æ˜¯å¦æœ‰æ•ˆ:", isValid);
                    return isValid;
                })
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // è¡¨æ ¼æŒ‰æ—¶é—´å€’åº
            
            console.log("å¤„ç†åçš„æ•°æ®:", processedData);
            
            // æ ¹æ®è¡¨æ ¼ç±»å‹å†³å®šæ˜¯å¦å»é‡
            let finalData;
            const isRagasTable = tableId.includes('ragas') || tableId.includes('Ragas');
            
            console.log("è¡¨æ ¼ç±»å‹æ£€æŸ¥:", {tableId, isRagasTable, isDateFiltered});
            
            if (isRagasTable) {
                // Ragasè¡¨æ ¼ï¼šæ°¸è¿œä¸å»é‡ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                console.log("Ragasè¡¨æ ¼ï¼Œä¸å»é‡");
                finalData = processedData;
            } else if (isDateFiltered) {
                // BM25è¡¨æ ¼ + åº”ç”¨æ—¥æœŸç­›é€‰æ—¶ï¼šæ˜¾ç¤ºæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®ï¼Œä¸å»é‡
                console.log("BM25è¡¨æ ¼ + å·²ç­›é€‰ï¼Œä¸å»é‡");
                finalData = processedData;
            } else {
                // BM25è¡¨æ ¼ + æœªåº”ç”¨ç­›é€‰æ—¶ï¼šè¿›è¡Œå»é‡ï¼ˆåŒä¸€å¤©åªæ˜¾ç¤ºæœ€æ–°çš„ï¼‰
                console.log("BM25è¡¨æ ¼ + æœªç­›é€‰ï¼Œå»é‡");
                const deduplicatedData = processedData.reduce((acc, current) => {
                    const dateKey = new Date(current.created_at).toISOString().split('T')[0];
                    if (!acc[dateKey] || new Date(current.created_at) > new Date(acc[dateKey].created_at)) {
                        acc[dateKey] = current;
                    }
                    return acc;
                }, {});
                finalData = Object.values(deduplicatedData);
            }
            
            console.log("æœ€ç»ˆæ•°æ®:", finalData);
            
            tbody.innerHTML = '';
            finalData.forEach((item, index) => {
                const row = document.createElement('tr');
                const date = new Date(item.created_at);
                const formattedDate = formatTableDate(date);
                const percentage = (item.value * 100).toFixed(1);
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td>${item.value.toFixed(4)}</td>
                    <td class="percentage-cell">${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ ¼å¼åŒ–è¡¨æ ¼ä¸­çš„æ—¥æœŸæ˜¾ç¤º
        function formatTableDate(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            // è¡¨æ ¼ä¸­åªæ˜¾ç¤ºæ—¥æœŸéƒ¨åˆ†ï¼šMM-DD
            return `${month}-${day}`;
        }

        // åˆå§‹åŒ–æ—¥æœŸè¾“å…¥æ¡†
        function initializeDateInputs() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘30å¤©ï¼‰
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            
            // ç¡®ä¿æ•´ä¸ªè¾“å…¥æ¡†éƒ½èƒ½ç‚¹å‡»æ‰“å¼€æ—¥æœŸé€‰æ‹©å™¨
            startDateInput.addEventListener('click', function() {
                this.showPicker();
            });
            
            endDateInput.addEventListener('click', function() {
                this.showPicker();
            });
        }

        // åº”ç”¨æ—¥æœŸç­›é€‰ï¼ˆä½¿ç”¨é˜²æŠ–ä¼˜åŒ–ï¼‰
        const applyDateFilter = debounce(function() {
            console.log("applyDateFilter è¢«è°ƒç”¨");
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log("é€‰æ‹©çš„æ—¥æœŸèŒƒå›´:", {startDate, endDate});
            
            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            isDateFiltered = true;
            console.log("è®¾ç½® isDateFiltered ä¸º true");
            
            // éšè—åˆå§‹æç¤º
            hideInitialHint();
            
            // é‡æ–°åŠ è½½æ‰€æœ‰å›¾è¡¨å’Œè¡¨æ ¼
            console.log("é‡æ–°åŠ è½½æ‰€æœ‰å›¾è¡¨å’Œè¡¨æ ¼");
            loadAllCharts();
            
            // æ˜¾ç¤ºç­›é€‰çŠ¶æ€
            showFilterStatus(startDate, endDate);
        }, 300);

        // é‡ç½®æ—¥æœŸç­›é€‰
        function resetDateFilter() {
            isDateFiltered = false;
            initializeDateInputs();
            
            // ä¸è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œæ˜¾ç¤ºåˆå§‹æç¤º
            showInitialHint();
            hideFilterStatus();
            
            // é‡ç½®å›¾è¡¨å’Œè¡¨æ ¼ä¸ºåˆå§‹çŠ¶æ€
            resetChartsAndTables();
        }
        
        // é‡ç½®å›¾è¡¨å’Œè¡¨æ ¼ä¸ºåˆå§‹çŠ¶æ€
        function resetChartsAndTables() {
            // é‡ç½®æ‰€æœ‰å›¾è¡¨åŠ è½½åŒºåŸŸ
            const loadingIds = [
                'bm25PrecisionLoading',
                'bm25RecallLoading',
                'bm25F1Loading',
                'bm25NDCGLoading',
                'ragasPrecisionLoading',
                'ragasRecallLoading'
            ];
            
            loadingIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹å›¾è¡¨';
                    element.style.display = 'flex';
                }
            });
            
            // éšè—æ‰€æœ‰å›¾è¡¨
            const chartIds = [
                'bm25PrecisionChart',
                'bm25RecallChart',
                'bm25F1Chart',
                'bm25NDCGChart',
                'ragasPrecisionChart',
                'ragasRecallChart'
            ];
            
            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // é‡ç½®æ‰€æœ‰è¡¨æ ¼
            const tableIds = [
                'bm25PrecisionTable',
                'bm25RecallTable',
                'ragasPrecisionTable',
                'ragasRecallTable'
            ];
            
            tableIds.forEach(id => {
                const table = document.getElementById(id);
                if (table) {
                    const tbody = table.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" class="loading-cell"><i class="fas fa-info-circle"></i> è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"åº”ç”¨ç­›é€‰"æŒ‰é’®æŸ¥çœ‹æ•°æ®</td></tr>';
                    }
                }
            });
            
            // é‡ç½®ç»Ÿè®¡æ•°æ®
            showInitialMessage();
        }

        // æ˜¾ç¤ºç­›é€‰çŠ¶æ€
        function showFilterStatus(startDate, endDate) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'filter-status';
            statusDiv.className = 'filter-status';
            statusDiv.innerHTML = `
                <i class="fas fa-filter"></i>
                å·²åº”ç”¨æ—¥æœŸç­›é€‰: ${startDate} è‡³ ${endDate}
                <button onclick="resetDateFilter()" class="clear-filter-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // æ’å…¥åˆ°headeråé¢
            const header = document.querySelector('.header');
            header.insertAdjacentElement('afterend', statusDiv);
        }

        // éšè—ç­›é€‰çŠ¶æ€
        function hideFilterStatus() {
            const statusDiv = document.getElementById('filter-status');
            if (statusDiv) {
                statusDiv.remove();
            }
        }

        // æ ¹æ®æ—¥æœŸç­›é€‰æ•°æ®
        function filterDataByDate(data, startDate, endDate) {
            console.log("filterDataByDate è¢«è°ƒç”¨:", {data, startDate, endDate});
            
            // ä¿®å¤ï¼šå§‹ç»ˆæ‰§è¡Œç­›é€‰é€»è¾‘ï¼Œä¸ä¾èµ– isDateFiltered æ ‡å¿—
            if (!data || !startDate || !endDate) {
                console.log("æ•°æ®æˆ–æ—¥æœŸä¸ºç©ºï¼Œè¿”å›åŸå§‹æ•°æ®");
                return data || [];
            }
            
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå¼€å§‹æ—¥æœŸçš„00:00:00.000
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // åŒ…å«ç»“æŸæ—¥æœŸçš„æ•´å¤©
            
            console.log("ç­›é€‰æ—¥æœŸèŒƒå›´:", {start, end});
            
            // ç­›é€‰æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ•°æ®ï¼Œä¸è¿‡æ»¤åŒä¸€å¤©çš„æ•°æ®
            const result = data.filter(item => {
                if (!item.created_at) return false;
                const itemDate = new Date(item.created_at);
                console.log(`æ£€æŸ¥æ•°æ®é¡¹: ${item.created_at} (${itemDate}) æ˜¯å¦åœ¨ ${start} å’Œ ${end} ä¹‹é—´`);
                const isInRange = itemDate >= start && itemDate <= end;
                console.log(`ç»“æœ: ${isInRange}`);
                return isInRange;
            });
            
            console.log("filterDataByDate è¿”å›ç»“æœ:", result);
            return result;
        }

        // æ˜¾ç¤ºè¡¨æ ¼é”™è¯¯
        function showTableError(tableId, message) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = `<tr><td colspan="4" class="loading-cell" style="color: #e74c3c;">${message}</td></tr>`;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.charts-grid'));
        }

        // æ—¥æœŸå¤„ç†è¾…åŠ©å‡½æ•°
        function getDateRange(dates) {
            if (!dates || dates.length === 0) return { days: 0, hours: 0 };
            
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            const diffMs = maxDate - minDate;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
            
            return { days: diffDays, hours: diffHours };
        }

        function getOptimalDateFormat(dateRange) {
            // æ¨ªè½´æ˜¾ç¤ºæ ¼å¼ï¼šMM-DD HH MM
            return '%m-%d %H %M';
        }

        function formatDateForHover(date, dateRange) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            // æ‚¬åœæ–‡æœ¬æ˜¾ç¤ºå®Œæ•´çš„æ—¥æœŸæ—¶é—´ä¿¡æ¯ï¼šMM-DD HH:MM
            return `${month}-${day} ${hours}:${minutes}`;
        }
    </script>
    <script src="/static/utils/debounce.js"></script>
    <script src="/static/components/navigation.js"></script>
</body>
</html>
